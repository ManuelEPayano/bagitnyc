
<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->  <html class="no-js" lang="en"> <!--<![endif]-->
<head>
<link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css" />
<script src="http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js"></script>


<style>

ul.columns{ 
    width: 50%;
    float: left;
    margin: 0 0 3em 0;
    padding: 0;
    list-style: none;
    border: 1px 1px 1px 1px;
/*    background-color: #f2f2f2;*/
/*
    border-bottom: 1px solid #ccc;
    border-top: 1px solid #ccc;
*/
}

ul.columns>li {
    float: left;
    padding:10px 15px 10px 15px;
}

ul.dynamic-list{ 
    padding: 0;
    list-style: none;
    background-color: #f2f2f2;
    border-bottom: 1px solid #ccc;
    border-top: 1px solid #ccc;
}
    span.numbers{
float: right;
}


    
#map{
width:50%;
height:800px;
float: right;
}
div.cartodb-tooltip-content{
display:none;
}
    
    
</style>

<body> 





<div id="map">
</div>


<div id="menu">
    
<ul class="columns">
<li>
<a href='#'>Events</a>
<ul id="events-list" class="dynamic-list">

</ul>
</li>

<li class="participants">
<a href='#'>Participants</a>
<ul id="participants-list" class="dynamic-list">
</ul>
</li>

<li class="districts">
<a href='#'>Districts</a>
<ul id="districts-list" class="dynamic-list">
</ul>
</li>
    
</ul>

</div>

<script>

var map = L.map('map').setView([40.711000, -73.947826], 14);

var circle_coundist = "";
var polygon_coundist = "";

L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
maxZoom: 18,
minZoom:11,
attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
//			id: 'examples.map-20v6611k'
}).addTo(map);

//global variables for cartodb SQL 
var sql = new cartodb.SQL({ user: 'jossphilippe' });
var layerURL="http://jossphilippe.cartodb.com/api/v2/viz/4dedce04-91da-11e3-ada5-0e49973114de/viz.json"

//global variables for dynamic layer selections
var instagrams;
var districts;

//global variables for dynamic list items
var users;
var count;

//create layer and assign variables to sublayers

cartodb.createLayer(map, layerURL)
.done(function(layer) {
districts = layer.getSubLayer(0);  
instagrams = layer.getSubLayer(1);

console.log(instagrams);


}).addTo(map);


//update list of events according to affiliation field
//get array of participating users and populate dropdown list items
$.getJSON("https://jossphilippe.cartodb.com/api/v2/sql?q=SELECT affiliation, count(*) number FROM instagram_media WHERE affiliation IS NOT NULL GROUP BY affiliation ORDER BY number DESC", function(data){

//    $.getJSON("https://jossphilippe.cartodb.com/api/v2/sql?q=SELECT * FROM instagram_media", function(data){
var html = '';

//console.log(event);
for(var i = 0; i < data.rows.length; i++) {

var items = data.rows[i];

count = items.number;
affiliation = items.affiliation;


//update html var with list-item data and anchored text

html += '<li data='+ affiliation +' class="options-list"><a>' + affiliation + '&nbsp;</a><span class="numbers">' + count + '</span></li>';
document.getElementById('events-list').innerHTML = html;

}
})


//update list of participants according to click events in other <UL>
var updateParticipants = function(event){

console.log("running");
//encode paraemter to be used in url SQL statements and getJSON method
event = encodeURIComponent(event);

//update map layers
instagrams.setSQL("SELECT * FROM instagram_media WHERE affiliation='"+event+"'");

districts.setSQL("SELECT DISTINCT(d1.*) FROM nycc_merge_final d1, instagram_media d2 WHERE ST_Contains(d1.the_geom,d2.the_geom) AND d2.affiliation='"+event+"'");  

//pan and zoom map to show both extent of both layers
sql.getBounds("SELECT * FROM instagram_media WHERE affiliation='"+event+"'").done(function(bounds) {
map.fitBounds(bounds);
});


//get array of participating users and populate dropdown list items
$.getJSON("https://jossphilippe.cartodb.com/api/v2/sql?q=SELECT media_credit, count(*) number FROM instagram_media WHERE affiliation='"+event+"'GROUP BY media_credit ORDER BY number DESC", function(data){

//    $.getJSON("https://jossphilippe.cartodb.com/api/v2/sql?q=SELECT * FROM instagram_media", function(data){
var html = '';

//console.log(event);
for(var i = 0; i < data.rows.length; i++) {

var items = data.rows[i];

count = items.number;
users = items.media_credit;

//console.log(users);
users = [];
users.push(data.rows[i].media_credit);
//    console.log(users);

hist = users.reduce( function (prev, item) { 
if ( item in prev ) prev[item] ++; 
else prev[item] = 1; 
return prev; 
}, {} );
console.log(hist);




//update html var with list-item data and anchored text

html += '<li data='+ users +' class="options-list"><a>' + users + '&nbsp;</a><span class="numbers">' + count + '</span></li>';
document.getElementById('participants-list').innerHTML = html;

}
})
};

    
    //update list of participants according to click events in other <UL>
var updateDistricts = function(event){
    
    event = encodeURIComponent(event);

    $.getJSON("https://jossphilippe.cartodb.com/api/v2/sql?q=SELECT DISTINCT(d1.*) FROM nycc_merge_final d1, instagram_media d2 WHERE ST_Contains(d1.the_geom,d2.the_geom) AND d2.affiliation='"+event+"'", function(data){
var html = '';
for(var i = 0; i < data.rows.length; i++) {

var rep = data.rows[i].name;
var dist = data.rows[i].coundist;
//var points = data.rows[i].points_count;

//update html var with list-item data and anchored text
//assign var to li data value, in order to better listen for click events
html += '<li data='+ dist +' class="options-list"><a>District ' + dist + '&nbsp;</a><span class="numbers"></span></li>';

document.getElementById('districts-list').innerHTML = html;

}
})
};

$("#events-list").on('click', 'li', function(){
target = $(this).attr('data');
updateParticipants(target);
updateDistricts(target);
});

//$("#new_school").on('click', 'button', function(){
//target = $(this).attr('value');
//updateParticipants(target);
////                console.log("you clicked");
//});


//updateParticipants("new_school");
</script>
</body>
